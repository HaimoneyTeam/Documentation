<!DOCTYPE html>
<html>
<head>
    <title>HarbourX - Feature Design</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 3px solid #27ae60;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            border-bottom: 1px solid #bdc3c7;
            padding-bottom: 5px;
        }
        .diagram-container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .summary-box {
            background: #e8f6f3;
            border-left: 4px solid #16a085;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .domain-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .domain-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .user-domain {
            border-top: 4px solid #3498db;
        }
        .business-domain {
            border-top: 4px solid #27ae60;
        }
        .explanation-box {
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .mermaid a {
            color: #1976d2;
            text-decoration: underline;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <h1>HarbourX - Feature Design</h1>
    
    <div class="summary-box">
        <h3>üéØ Architecture Overview</h3>
        <p>This unified schema combines:</p>
        <ul>
            <li><strong>User & Access Management:</strong> Users, roles, permissions, and relationships</li>
            <li><strong>Business Domain:</strong> Companies, loans, commissions, RCTI, and file processing</li>
            <li><strong>Key Innovation:</strong> Brokers are users with roles, companies are flexible entities</li>
        </ul>
    </div>

    <div class="diagram-container">
        <h2>üöÄ System Features & Capabilities</h2>
        
        <div class="domain-grid">
            <div class="domain-card" style="border-top: 4px solid #e74c3c;">
                <h3>1. Microservices ‚Üí Monolith</h3>
                <p><strong>Current:</strong> 11 separate services with duplicated data</p>
                <p><strong>New:</strong> Unified database with ACID transactions</p>
                <ul>
                    <li>Single source of truth</li>
                    <li>No data synchronization issues</li>
                    <li>Simplified deployment</li>
                    <li>Lower operational costs</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #9b59b6;">
                <h3>2. Referral System</h3>
                <p><strong>Flexible relationship management:</strong></p>
                <ul>
                    <li>Referrer/Referee relationships</li>
                    <li>Commission splitting rules</li>
                    <li>Multi-party referrals</li>
                    <li>Automated referral fees</li>
                    <li>Track referral sources</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #3498db;">
                <h3>3. Kanban Loan Management</h3>
                <p><strong>Visual pipeline management:</strong></p>
                <ul>
                    <li>Drag-drop loan stages</li>
                    <li>Custom workflow states</li>
                    <li>Automated status updates</li>
                    <li>Task assignments</li>
                    <li>SLA tracking</li>
                    <li><a href="https://github.com/JordanKnott/taskcafe/blob/master/.github/taskcafe_preview.png" target="_blank" style="color: #1976d2; text-decoration: underline;">üìã View Kanban Preview</a></li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #2ecc71;">
                <h3>4. Client Portal</h3>
                <p><strong>For broker's clients to upload loan documents:</strong></p>
                <ul>
                    <li>Original loan document uploads</li>
                    <li>Digital signature (DocuSign style)</li>
                    <li>Application status tracking</li>
                    <li>Secure document submission</li>
                    <li>Direct communication with broker</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #f39c12;">
                <h3>5. Commission Processing</h3>
                <p><strong>Automated calculations:</strong></p>
                <ul>
                    <li>Upfront & trail commissions</li>
                    <li>Complex split rules</li>
                    <li>RCTI generation</li>
                    <li>Fee deductions</li>
                    <li>Bulk processing via Excel</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #e67e22;">
                <h3>6. AI/ML Engine</h3>
                <p><strong>Intelligent automation & analysis:</strong></p>
                <ul>
                    <li><strong>AI Loan Summary:</strong> Auto-generate loan summaries from applications</li>
                    <li><strong>Compliance File Generation:</strong> Create regulatory documents automatically</li>
                    <li><strong>Best Interest Duty:</strong> Ensure compliance with regulatory requirements</li>
                    <li><strong>Factfind Extraction:</strong> Extract client information from documents</li>
                    <li><strong>Financial Report Analysis:</strong> Parse bank statements & financial docs</li>
                    <li><strong>Pay Slip Analysis & Info Extraction:</strong> Extract income data automatically</li>
                    <li><strong>Risk Assessment:</strong> AI-powered risk scoring & fraud detection</li>
                    <li><strong>Document Classification:</strong> Auto-categorize uploaded documents</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #1abc9c;">
                <h3>7. API Integrations</h3>
                <p><strong>Third-party connections:</strong></p>
                <ul>
                    <li>Lender APIs</li>
                    <li>Credit check services</li>
                    <li>Identity verification</li>
                    <li>Property valuation</li>
                    <li>Banking data feeds</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #34495e;">
                <h3>8. Future Extensibility</h3>
                <p><strong>Built for growth:</strong></p>
                <ul>
                    <li>JSONB for flexible data</li>
                    <li>Dynamic relationships</li>
                    <li>Unlimited company types</li>
                    <li>Custom workflows</li>
                    <li>Plugin architecture ready</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="diagram-container">
        <h2>Why This Architecture?</h2>
        
        <div class="explanation-box" style="background: #fadbd8; border-left: 4px solid #c62828;">
            <h3>‚ö†Ô∏è Current System Limitations</h3>
            <p><strong>Critical issues with the existing microservices architecture:</strong></p>
            
            <h4>1. Data Duplication & Inconsistency</h4>
            <ul>
                <li>Same broker data exists in 5+ different databases</li>
                <li>RCTI data scattered across multiple services</li>
                <li>Data synchronization failures causing inconsistencies</li>
                <li>No single source of truth for critical business data</li>
            </ul>
            
            <h4>2. Over-Engineered Code</h4>
            <ul>
                <li>Most services are AI-generated with excessive complexity</li>
                <li>Simple CRUD operations have 1000+ lines of boilerplate</li>
                <li>Difficult to understand and maintain</li>
                <li>Bug fixes require changes in multiple services</li>
            </ul>
            
            <h4>3. Infrastructure Overkill</h4>
            <ul>
                <li><strong>K8s is massively over-provisioned:</strong> CPU usage &lt;20%, Network &lt;20%, DB &lt;20%</li>
                <li>Managing CSV files in pods is fragile and ugly</li>
                <li>PostgreSQL running in pods without proper backup</li>
                <li>Complex orchestration for simple workflows</li>
            </ul>
            
            <h4>4. No Monitoring or Observability</h4>
            <ul>
                <li>No centralized monitoring dashboard</li>
                <li>Cannot track system health or performance</li>
                <li>Debugging requires checking 11 different log streams</li>
                <li>No alerting for failures or issues</li>
            </ul>
        </div>
        
        <div class="explanation-box" style="background: #e8f6f3; border-left: 4px solid #16a085;">
            <h3>‚úÖ Solution: Monolithic Architecture</h3>
            <p><strong>How the new architecture addresses these issues:</strong></p>
            
            <h4>1. Data Unification</h4>
            <ul>
                <li><strong>Before:</strong> 11 databases with duplicated, inconsistent data</li>
                <li><strong>After:</strong> Single PostgreSQL database with normalized schema</li>
                <li><strong>Result:</strong> Zero data duplication, 100% consistency</li>
            </ul>
            
            <h4>2. Simplified Codebase</h4>
            <ul>
                <li><strong>Before:</strong> Over-complicated AI-generated services</li>
                <li><strong>After:</strong> Clean, maintainable monolithic codebase</li>
                <li><strong>Result:</strong> 60% less code, easier to understand and debug</li>
            </ul>
            
            <h4>3. Right-Sized Infrastructure</h4>
            <ul>
                <li><strong>Before:</strong> K8s with &lt;20% resource utilization</li>
                <li><strong>After:</strong> Simple deployment on 2-3 VMs or containers</li>
                <li><strong>Result:</strong> 80% infrastructure cost reduction</li>
            </ul>
            
            <h4>4. Built-in Monitoring</h4>
            <ul>
                <li><strong>Before:</strong> No monitoring or observability</li>
                <li><strong>After:</strong> Grafana + Prometheus from day one</li>
                <li><strong>Result:</strong> Full visibility into system health and performance</li>
            </ul>
            
            <h4>5. Additional Benefits</h4>
            <ul>
                <li>ACID transactions across all operations</li>
                <li>No network latency between services</li>
                <li>Simpler deployment and maintenance</li>
                <li>Faster development of new features</li>
                <li>Easy local development environment</li>
            </ul>
        </div>
        
        <div class="mermaid">
flowchart LR
    subgraph "Current: Microservices"
        MS1[Auth Service]
        MS2[Broker Service]
        MS3[Commission Service]
        MS4[RCTI Service]
        MS5[File Service]
        MS6[Mail Service]
        MS7[Loan Service]
        MS8[Profile Service]
        MS9[Gateway]
        
        MS9 --> MS1
        MS9 --> MS2
        MS9 --> MS3
        MS9 --> MS4
        MS9 --> MS5
        MS9 --> MS6
        MS9 --> MS7
        MS9 --> MS8
    end
    
    subgraph "New: Monolith with Features"
        M[Unified Application]
        
        M --> F1[User Management]
        M --> F2[Referral System]
        M --> F3[Kanban Loans]
        M --> F4[Client Portal]
        M --> F5[Commissions]
        M --> F6[AI/ML Engine]
        M --> F7[API Gateway]
        M --> F8[RCTI]
    end
    
    MS9 ==>|Migration| M
    
    style M fill:#2ecc71
    style MS9 fill:#e74c3c
        </div>
    </div>

    <div class="diagram-container">
        <h2>Complete System Architecture</h2>
        <div class="mermaid">
flowchart TB
    subgraph "Layer 1: User Interface"
        direction LR
        Portal[fa:fa-user-circle Client Portal<br/>For Loan Applicants]
        Kanban[fa:fa-columns Kanban Board<br/>For Brokers<br/><a href='https://github.com/JordanKnott/taskcafe/blob/master/.github/taskcafe_preview.png' target='_blank'>Preview</a>]
        Dashboard[fa:fa-chart-line Dashboard<br/>For Brokers]
    end
    
    subgraph "Layer 2: Core Features"
        direction LR
        Users[fa:fa-users Users]
        Companies[fa:fa-building Companies]
        Referral[fa:fa-handshake Referrals]
        AI[fa:fa-robot AI Engine<br/>‚Ä¢ Loan Summary<br/>‚Ä¢ Compliance Gen<br/>‚Ä¢ Best Interest Duty<br/>‚Ä¢ Factfind Extract<br/>‚Ä¢ Financial Analysis<br/>‚Ä¢ Pay Slip Analysis]
    end
    
    subgraph "Layer 3: Business Logic"
        direction LR
        Loans[fa:fa-file-invoice Loans]
        Settlements[fa:fa-check Settlements]
        Files[fa:fa-upload File Processing<br/>‚Ä¢ DOCX, PDF, Excel, CSV<br/>‚Ä¢ RCTI from Lenders<br/>‚Ä¢ Multi-format Parsing<br/>‚Ä¢ Data Extraction]
    end
    
    subgraph "Layer 4: Financial Processing"
        direction LR
        Upfront[fa:fa-dollar Upfront Comm.]
        Trail[fa:fa-sync Trail Comm.]
        RCTI[fa:fa-receipt RCTI]
    end
    
    subgraph "Layer 5: Data Storage"
        direction LR
        PG[(PostgreSQL)]
        Mongo[(MongoDB)]
        S3[fa:fa-cloud S3 Storage]
    end
    
    %% Simplified connections between layers
    Portal --> Users
    Kanban --> Loans
    Dashboard --> Loans
    
    Users --> Loans
    Companies --> Loans
    Referral --> Loans
    AI --> Loans
    
    Loans --> Settlements
    Files --> Settlements
    
    Settlements --> Upfront
    Settlements --> Trail
    
    Upfront --> RCTI
    Trail --> RCTI
    
    RCTI --> PG
    Loans --> PG
    Files --> S3
    AI --> Mongo
    
    %% Styles
    classDef uiClass fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef featureClass fill:#e8f8f5,stroke:#00897b,stroke-width:2px
    classDef businessClass fill:#fef9e7,stroke:#f9a825,stroke-width:2px
    classDef financeClass fill:#fdebd0,stroke:#ef6c00,stroke-width:2px
    classDef dataClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    
    class Portal,Kanban,Dashboard uiClass
    class Users,Companies,Referral,AI featureClass
    class Loans,Settlements,Files businessClass
    class Upfront,Trail,RCTI financeClass
    class PG,Mongo,S3 dataClass
        </div>
    </div>

    <div class="domain-grid">
        <div class="domain-card user-domain">
            <h3>üë§ User & Access Domain</h3>
            <p><strong>Core Tables:</strong></p>
            <ul>
                <li><code>users</code> - All system users including brokers</li>
                <li><code>roles</code> - System roles (broker, admin, etc.)</li>
                <li><code>permissions</code> - Granular access controls</li>
                <li><code>user_roles</code> - User-role assignments</li>
                <li><code>relationships</code> - User relationships (mentor, referral)</li>
                <li><code>audit_logs</code> - System audit trail</li>
            </ul>
            <p><strong>Key Features:</strong></p>
            <ul>
                <li>Unified authentication system</li>
                <li>Role-based access control (RBAC)</li>
                <li>Flexible relationship management</li>
                <li>Complete audit trail</li>
            </ul>
        </div>

        <div class="domain-card business-domain">
            <h3>üíº Business Operations Domain</h3>
            <p><strong>Core Tables:</strong></p>
            <ul>
                <li><code>companies</code> - All organizations</li>
                <li><code>loans</code> - Loan applications</li>
                <li><code>settlements</code> - Settled loans</li>
                <li><code>upfront_commissions</code> - One-time payments</li>
                <li><code>trail_commissions</code> - Ongoing payments</li>
                <li><code>rcti_invoices</code> - Tax invoices</li>
                <li><code>document_uploads</code> - All file processing records</li>
            </ul>
            <p><strong>Key Features:</strong></p>
            <ul>
                <li>Flexible company types</li>
                <li>Commission calculation & tracking</li>
                <li>RCTI generation</li>
                <li><strong>Advanced File Processing:</strong> DOCX, PDF, Excel, CSV, RCTI files from lenders</li>
                <li>Multi-format document parsing & data extraction</li>
            </ul>
        </div>
    </div>

    <div class="diagram-container">
        <h2>Commission Processing Flow</h2>
        <div class="mermaid">
sequenceDiagram
    participant User as User (Broker)
    participant Company
    participant Loan
    participant Settlement
    participant Commission
    participant RCTI
    participant FileUpload
    
    User->>Loan: Creates loan
    Note over User,Company: User has broker role
    Company->>Loan: Processes loan
    
    Loan->>Settlement: Loan settles
    
    alt Via File Upload
        FileUpload->>Commission: Import commissions
    else Direct Processing
        Settlement->>Commission: Generate commissions
    end
    
    Note over Commission: Apply company's commission model
    Note over Commission: Calculate splits if parent-child
    
    Commission->>RCTI: Add to invoice
    
    RCTI->>User: Individual payment
    RCTI->>Company: Company payment
        </div>
    </div>

    <div class="diagram-container">
        <h2>Data Relationships Map - Complete Example</h2>
        <div class="mermaid">
graph TB
    subgraph "User: John Smith (ID: 101)"
        U1[fa:fa-user John Smith<br/>User ID: 101]
    end
    
    subgraph "System Roles"
        U1 --> SR1[fa:fa-shield-alt Role: Broker]
        U1 --> SR2[fa:fa-shield-alt Role: Mentor]
        U1 --> SR3[fa:fa-shield-alt Role: Referrer]
        U1 --> SR4[fa:fa-shield-alt Role: Admin]
    end
    
    subgraph "Company Relationships"
        U1 --> C1[fa:fa-building ABC Brokers<br/>Role: Senior Broker<br/>Code: ABC001]
        U1 --> C2[fa:fa-building XYZ Accounting<br/>Role: Consultant]
    end
    
    subgraph "Dynamic Relationships (Unlimited Types)"
        U1 -->|Mentor| REL1[fa:fa-graduation-cap Mentorship<br/>with Mary Lee]
        U1 -->|Referrer| REL2[fa:fa-handshake Referral Partnership<br/>with Bob's Law Firm]
        U1 -->|Custom Role| REL3[fa:fa-users Any Future Relationship<br/>Dynamically Defined]
        U1 -->|Parent Broker| REL4[fa:fa-sitemap Broker Hierarchy<br/>2 sub-brokers]
    end
    
    subgraph "Other Participants (Any Role Possible)"
        REL1 --> P1[Mary Lee<br/>Roles: Broker, Mentee]
        REL2 --> P2[Bob Chen<br/>Roles: Lawyer, Referee]
        REL2 --> P3[Sarah Admin<br/>Roles: Admin, Witness]
        REL3 --> P4[User A<br/>Role: Any Future Role]
        REL3 --> P5[User B<br/>Role: Any Future Role]
        REL4 --> P6[Tom Wilson<br/>Roles: Broker, Sub-broker<br/>Split: 70%]
        REL4 --> P7[Jane Doe<br/>Roles: Broker, Sub-broker<br/>Split: 60%]
    end
    
    subgraph "Business Activity"
        U1 --> L1[fa:fa-file-invoice Loan #1001<br/>$500,000]
        U1 --> L2[fa:fa-file-invoice Loan #1002<br/>$750,000]
    end
    
    subgraph "Commission Flow"
        L1 --> COM1[fa:fa-dollar-sign Commission<br/>$3,250]
        L2 --> COM2[fa:fa-dollar-sign Commission<br/>$4,875]
        COM1 -->|30% to John| SPLIT1[$975]
        COM1 -->|70% to Tom| SPLIT2[$2,275]
    end
    
    subgraph "Financial Output"
        SPLIT1 --> RCTI1[fa:fa-receipt RCTI #INV001<br/>John: $5,850]
        COM2 --> RCTI1
        SPLIT2 --> RCTI2[fa:fa-receipt RCTI #INV002<br/>Tom: $2,275]
    end
    
    %% Styles
    classDef userClass fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef companyClass fill:#e8f8f5,stroke:#00897b,stroke-width:2px
    classDef relClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef participantClass fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef loanClass fill:#fef9e7,stroke:#f9a825,stroke-width:2px
    classDef commissionClass fill:#fdebd0,stroke:#ef6c00,stroke-width:2px
    classDef invoiceClass fill:#fadbd8,stroke:#c62828,stroke-width:2px
    
    class U1 userClass
    class C1,C2 companyClass
    class REL1,REL2,REL3,REL4 relClass
    class P1,P2,P3,P4,P5,P6,P7 participantClass
    class L1,L2 loanClass
    class COM1,COM2,SPLIT1,SPLIT2 commissionClass
    class RCTI1,RCTI2 invoiceClass
        </div>
    </div>

    <div class="diagram-container">
        <h2>Key Design Principles</h2>
        <div class="domain-grid">
            <div class="domain-card">
                <h3>‚úÖ Single Source of Truth</h3>
                <ul>
                    <li>One <code>users</code> table for all identities</li>
                    <li>One <code>companies</code> table for all organizations</li>
                    <li>Relationships defined once, referenced everywhere</li>
                    <li>No data duplication across domains</li>
                </ul>
            </div>
            
            <div class="domain-card">
                <h3>‚úÖ Flexibility & Extensibility</h3>
                <ul>
                    <li>JSONB fields for custom data</li>
                    <li>Dynamic company types</li>
                    <li>Configurable relationships</li>
                    <li>Role-based permissions</li>
                </ul>
            </div>
            
            <div class="domain-card">
                <h3>‚úÖ Data Integrity</h3>
                <ul>
                    <li>Foreign key constraints</li>
                    <li>Unique constraints on business keys</li>
                    <li>Audit logs for all changes</li>
                    <li>Transaction support (ACID)</li>
                </ul>
            </div>
            
            <div class="domain-card">
                <h3>‚úÖ Performance</h3>
                <ul>
                    <li>Strategic indexes on foreign keys</li>
                    <li>Lookup indexes on frequently queried fields</li>
                    <li>JSONB indexes for flexible queries</li>
                    <li>Partitioning ready for large tables</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="diagram-container">
        <h2>Example: Complete User Journeys</h2>
        <div class="mermaid">
graph TD
    subgraph "Journey 1: Broker with Commission"
        A1[John joins as User] -->|Assigned Role| B1[Becomes Broker]
        B1 -->|Joins Company| C1[Works at ABC Brokers]
        C1 -->|Creates Relationship| D1[Mentors Sub-broker Mary]
        
        C1 -->|Originates| E1[Loan Application]
        E1 -->|Settles| F1[Settlement Created]
        F1 -->|Generates| G1[Upfront Commission]
        
        G1 -->|Split with Mary| H1[Commission Split]
        H1 -->|Included in| I1[RCTI Invoice]
        I1 -->|Payment| J1[John Paid 70%]
        I1 -->|Payment| K1[Mary Paid 30%]
    end
    
    subgraph "Journey 2: Referral Partnership"
        A2[Bob joins as User] -->|Assigned Role| B2[Becomes Lawyer]
        B2 -->|Joins Company| C2[Works at Law Firm]
        
        A3[Alice joins as User] -->|Assigned Role| B3[Becomes Broker]
        B3 -->|Joins Company| C3[Works at XYZ Finance]
        
        C2 -->|Creates Relationship| D2[Referral Partnership]
        C3 -->|Joins Relationship| D2
        
        D2 -->|Bob as Referrer| E2[Refers Client]
        D2 -->|Alice as Referee| F2[Receives Client]
        
        F2 -->|Creates| G2[Loan for Client]
        G2 -->|Generates| H2[Commission]
        H2 -->|Referral Fee| I2[Bob Gets 20%]
        H2 -->|Commission| J2[Alice Gets 80%]
    end
    
    subgraph "Journey 3: Mentor-Mentee Relationship"
        A4[Senior Broker Sarah] -->|Assigned Role| B4[Becomes Mentor]
        A5[Junior Broker Mike] -->|Assigned Role| C4[Becomes Mentee]
        
        B4 -->|Creates Relationship| D4[Mentorship Program]
        C4 -->|Joins as Mentee| D4
        
        D4 -->|Training Period| E4[Mike learns processes]
        E4 -->|Mike Creates| F4[First Loan Application]
        F4 -->|Generates| G4[Commission]
        
        G4 -->|Mentor Split| H4[Sarah Gets 30% Training Fee]
        G4 -->|Mentee Share| I4[Mike Gets 70%]
        
        E4 -->|After 6 months| J4[Mike becomes Independent]
        J4 -->|New Relationship| K4[Mike can become Mentor]
    end
    
    subgraph "Journey 4: Dynamic Future Relationship"
        A7[User X] -->|Custom Role| B7[Investment Advisor]
        A8[User Y] -->|Custom Role| C7[Property Developer]
        A9[User Z] -->|Custom Role| D7[Finance Broker]
        
        B7 -->|Creates| E7[Joint Venture Relationship]
        C7 -->|Joins| E7
        D7 -->|Joins| E7
        
        E7 -->|Flexible Rules| F7[Custom Business Logic]
        F7 -->|Configurable| G7[Any Future Workflow]
    end
    
    style A1 fill:#e3f2fd
    style C1 fill:#e8f8f5
    style E1 fill:#fef9e7
    style I1 fill:#fadbd8
    style J1 fill:#d4edda
    style K1 fill:#d4edda
    
    style A2 fill:#e3f2fd
    style C2 fill:#e8f8f5
    style D2 fill:#f3e5f5
    style I2 fill:#d4edda
    style J2 fill:#d4edda
    
    style A4 fill:#e3f2fd
    style D4 fill:#f3e5f5
    style G4 fill:#fef9e7
    style H4 fill:#d4edda
    style I4 fill:#d4edda
    style K4 fill:#fff3e0
    
    style E7 fill:#f3e5f5
    style G7 fill:#fff3e0
        </div>
    </div>

    <div class="summary-box">
        <h3>üìã Implementation Roadmap & Tasks</h3>
        
        <div class="domain-grid">
            <div class="domain-card" style="border-top: 4px solid #e74c3c;">
                <h3>Phase 1: UI/UX Design</h3>
                <h4>Design System & User Experience</h4>
                <ul>
                    <li>‚¨ú User research & personas</li>
                    <li>‚¨ú Information architecture</li>
                    <li>‚¨ú Wireframes for all modules</li>
                    <li>‚¨ú Design system & component library</li>
                    <li>‚¨ú Kanban board UI design</li>
                    <li>‚¨ú Client portal interface</li>
                    <li>‚¨ú Mobile responsive design</li>
                    <li>‚¨ú Usability testing</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #3498db;">
                <h3>Phase 2: Database Architecture</h3>
                <h4>Data Layer Foundation</h4>
                <ul>
                    <li>‚úÖ Design unified database schema</li>
                    <li>‚úÖ Define all entity relationships</li>
                    <li>‚¨ú Create migration scripts from microservices</li>
                    <li>‚¨ú Set up database indexes and constraints</li>
                    <li>‚¨ú Implement audit logging structure</li>
                    <li>‚¨ú Data deduplication strategy</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #9b59b6;">
                <h3>Phase 3: Tech Stack Selection</h3>
                <h4>Technology Decisions</h4>
                <ul>
                    <li>‚¨ú Backend: Go (simplify) or Node.js/Python</li>
                    <li>‚¨ú Frontend: Next.js + TypeScript + Tailwind</li>
                    <li>‚¨ú Database: PostgreSQL with JSONB</li>
                    <li>‚¨ú Cache: Redis for sessions</li>
                    <li>‚¨ú Simple queue: Redis/Bull (no RabbitMQ)</li>
                    <li>‚¨ú Monitoring: Grafana + Prometheus</li>
                    <li>‚¨ú AI/ML: OpenAI API or Python service</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #2ecc71;">
                <h3>Phase 4: Core Migration</h3>
                <h4>Monolith Development</h4>
                <ul>
                    <li>‚¨ú User & authentication system</li>
                    <li>‚¨ú Company & role management</li>
                    <li>‚¨ú Loan processing pipeline</li>
                    <li>‚¨ú Commission calculations</li>
                    <li>‚¨ú RCTI generation</li>
                    <li>‚¨ú Data migration & cleanup</li>
                    <li>‚¨ú Remove K8s complexity</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #f39c12;">
                <h3>Phase 5: Frontend Implementation</h3>
                <h4>User Interface Development</h4>
                <ul>
                    <li>‚¨ú Component library implementation</li>
                    <li>‚¨ú Dashboard & analytics views</li>
                    <li>‚¨ú Kanban board interface</li>
                    <li>‚¨ú Client portal</li>
                    <li>‚¨ú Document upload UI</li>
                    <li>‚¨ú Digital signature flow</li>
                    <li>‚¨ú Mobile-first responsive design</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #e67e22;">
                <h3>Phase 6: New Features</h3>
                <h4>Feature Implementation</h4>
                <ul>
                    <li>‚¨ú Referral system with splits</li>
                    <li>‚¨ú Kanban loan management</li>
                    <li>‚¨ú Client portal & uploads</li>
                    <li>‚¨ú Digital signatures</li>
                    <li>‚¨ú <strong>AI Loan Summary</strong> - Auto-generate comprehensive loan summaries</li>
                    <li>‚¨ú <strong>Compliance File Generation</strong> - Automated regulatory documents</li>
                    <li>‚¨ú <strong>Best Interest Duty</strong> - Compliance checking & recommendations</li>
                    <li>‚¨ú <strong>Factfind Extraction</strong> - Extract client data from documents</li>
                    <li>‚¨ú <strong>Financial Report Analysis</strong> - Parse bank statements automatically</li>
                    <li>‚¨ú <strong>Pay Slip Analysis</strong> - Income verification & extraction</li>
                    <li>‚¨ú Advanced file processing (DOCX, PDF, Excel, CSV, RCTI)</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #8e44ad;">
                <h3>Phase 7: Integrations</h3>
                <h4>External APIs</h4>
                <ul>
                    <li>‚¨ú Lender API connections</li>
                    <li>‚¨ú Credit check services</li>
                    <li>‚¨ú Identity verification (KYC)</li>
                    <li>‚¨ú Property valuation APIs</li>
                    <li>‚¨ú Banking data feeds</li>
                    <li>‚¨ú Document signing service</li>
                </ul>
            </div>

            <div class="domain-card" style="border-top: 4px solid #1abc9c;">
                <h3>Phase 8: Testing & Launch</h3>
                <h4>Quality Assurance & Deployment</h4>
                <ul>
                    <li>‚¨ú Unit & integration testing</li>
                    <li>‚¨ú Performance optimization</li>
                    <li>‚¨ú Security audit</li>
                    <li>‚¨ú User acceptance testing</li>
                    <li>‚¨ú Simple deployment (no K8s)</li>
                    <li>‚¨ú Monitoring setup</li>
                    <li>‚¨ú Training & documentation</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            er: {
                layoutDirection: 'TB',
                minEntityWidth: 100,
                minEntityHeight: 75,
                entityPadding: 15,
                stroke: '#333',
                fill: '#fff'
            }
        });
    </script>
</body>
</html>